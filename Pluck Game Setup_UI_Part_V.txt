using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows.Forms;
using System.Drawing;

public class PluckGameForm : Form
{
    private Label dealerLabel;
    private Label trumpLabel;
    private Button playRoundButton;
    private ListBox player1Hand;
    private ListBox player2Hand;
    private ListBox player3Hand;
    private Button playCardButton;
    private TextBox gameLog;
    private Label trickLabel;

    private Game game;
    private string currentPlayer = "Player 1";

    public PluckGameForm()
    {
        this.Text = "Pluck Card Game";
        this.Size = new Size(800, 600);

        dealerLabel = new Label() { Text = "Dealer: ", Location = new Point(20, 20), AutoSize = true };
        trumpLabel = new Label() { Text = "Trump: ", Location = new Point(20, 50), AutoSize = true };
        
        playRoundButton = new Button() { Text = "Play Round", Location = new Point(20, 80) };
        playRoundButton.Click += PlayRound_Click;

        playCardButton = new Button() { Text = "Play Card", Location = new Point(300, 80) };
        playCardButton.Click += PlayCard_Click;

        player1Hand = new ListBox() { Location = new Point(20, 120), Size = new Size(200, 150) };
        player2Hand = new ListBox() { Location = new Point(300, 120), Size = new Size(200, 150) };
        player3Hand = new ListBox() { Location = new Point(580, 120), Size = new Size(200, 150) };
        
        gameLog = new TextBox() { Location = new Point(20, 300), Size = new Size(760, 150), Multiline = true, ReadOnly = true };
        trickLabel = new Label() { Text = "Trick in Progress: ", Location = new Point(20, 460), Size = new Size(760, 30) };

        this.Controls.Add(dealerLabel);
        this.Controls.Add(trumpLabel);
        this.Controls.Add(playRoundButton);
        this.Controls.Add(playCardButton);
        this.Controls.Add(player1Hand);
        this.Controls.Add(player2Hand);
        this.Controls.Add(player3Hand);
        this.Controls.Add(gameLog);
        this.Controls.Add(trickLabel);

        game = new Game();
        UpdateUI();
    }

    private void PlayRound_Click(object sender, EventArgs e)
    {
        game.PlayRound();
        UpdateUI();
    }

    private void PlayCard_Click(object sender, EventArgs e)
    {
        ListBox currentPlayerHand = GetCurrentPlayerHand();
        if (currentPlayerHand.SelectedItem != null)
        {
            string selectedCard = currentPlayerHand.SelectedItem.ToString();
            game.PlayCard(currentPlayer, selectedCard);
            UpdateUI();
            
            // AI plays after human
            PlayAITurns();
        }
    }

    private void PlayAITurns()
    {
        List<string> aiPlayers = new List<string> { "Player 2", "Player 3" };
        foreach (var aiPlayer in aiPlayers)
        {
            string aiMove = game.GetAIMove(aiPlayer);
            if (!string.IsNullOrEmpty(aiMove))
            {
                game.PlayCard(aiPlayer, aiMove);
                gameLog.Text += $"\n{aiPlayer} played {aiMove}";
            }
        }
        UpdateUI();
    }

    private ListBox GetCurrentPlayerHand()
    {
        if (currentPlayer == "Player 1") return player1Hand;
        if (currentPlayer == "Player 2") return player2Hand;
        return player3Hand;
    }

    private void UpdateUI()
    {
        dealerLabel.Text = $"Dealer: {game.GetDealer()}";
        trumpLabel.Text = $"Trump: {game.GetTrumpSuit()}";

        player1Hand.Items.Clear();
        player2Hand.Items.Clear();
        player3Hand.Items.Clear();

        foreach (var card in game.GetPlayerHand("Player 1"))
            player1Hand.Items.Add(card);
        foreach (var card in game.GetPlayerHand("Player 2"))
            player2Hand.Items.Add(card);
        foreach (var card in game.GetPlayerHand("Player 3"))
            player3Hand.Items.Add(card);

        trickLabel.Text = $"Trick in Progress: {game.GetCurrentTrick()}";
        gameLog.Text += "\n" + game.GetLatestLog();
    }
}

class Game
{
    // AI Logic Refinement
    public string GetAIMove(string player)
    {
        var hand = GetPlayerHand(player);
        
        // AI prioritizes following suit if possible
        string leadSuit = GetCurrentLeadSuit();
        var suitedCards = hand.Where(card => card.Contains(leadSuit)).ToList();
        if (suitedCards.Count > 0)
        {
            return suitedCards.OrderBy(card => GetCardValue(card)).First();
        }

        // AI plays lowest value card if unable to follow suit
        return hand.OrderBy(card => GetCardValue(card)).First();
    }

    private int GetCardValue(string card)
    {
        Dictionary<string, int> rankValues = new Dictionary<string, int>()
        {
            { "2", 2 }, { "3", 3 }, { "4", 4 }, { "5", 5 }, { "6", 6 },
            { "7", 7 }, { "8", 8 }, { "9", 9 }, { "10", 10 }, { "J", 11 },
            { "Q", 12 }, { "K", 13 }, { "A", 14 }, { "Little Joker", 15 }, { "Big Joker", 16 }
        };
        
        string[] parts = card.Split(' ');
        return rankValues.ContainsKey(parts[0]) ? rankValues[parts[0]] : 0;
    }
}
