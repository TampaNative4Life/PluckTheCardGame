using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows.Forms;
using System.Drawing;
using System.Media;
using System.Threading.Tasks;

public class PluckGameForm : Form
{
    private Label dealerLabel;
    private Label trumpLabel;
    private Button playRoundButton;
    private ListBox player1Hand;
    private ListBox player2Hand;
    private ListBox player3Hand;
    private Button playCardButton;
    private Button pluckCardButton;
    private TextBox gameLog;
    private Label trickLabel;
    private Label pluckInstructionLabel;
    private ComboBox pluckSelectionBox;
    private Label statsLabel;
    private SoundPlayer cardPlaySound;
    private SoundPlayer pluckSound;

    private Game game;
    private string currentPlayer;
    private string plucker;
    private string pluckee;

    public PluckGameForm(bool multiplayerMode)
    {
        this.Text = "Pluck Card Game";
        this.Size = new Size(900, 650);

        dealerLabel = new Label() { Text = "Dealer: ", Location = new Point(20, 20), AutoSize = true, Font = new Font("Arial", 12, FontStyle.Bold) };
        trumpLabel = new Label() { Text = "Trump: ", Location = new Point(20, 50), AutoSize = true, Font = new Font("Arial", 12, FontStyle.Bold) };
        
        playRoundButton = new Button() { Text = "Play Round", Location = new Point(20, 80), Font = new Font("Arial", 10) };
        playRoundButton.Click += PlayRound_Click;

        playCardButton = new Button() { Text = "Play Card", Location = new Point(300, 80), Font = new Font("Arial", 10) };
        playCardButton.Click += PlayCard_Click;

        pluckCardButton = new Button() { Text = "Pluck Card", Location = new Point(500, 80), Font = new Font("Arial", 10), Enabled = false };
        pluckCardButton.Click += PluckCard_Click;

        player1Hand = new ListBox() { Location = new Point(20, 120), Size = new Size(200, 150), Font = new Font("Arial", 10) };
        player2Hand = new ListBox() { Location = new Point(300, 120), Size = new Size(200, 150), Font = new Font("Arial", 10) };
        player3Hand = new ListBox() { Location = new Point(580, 120), Size = new Size(200, 150), Font = new Font("Arial", 10) };
        
        gameLog = new TextBox() { Location = new Point(20, 300), Size = new Size(760, 150), Multiline = true, ReadOnly = true, Font = new Font("Arial", 10) };
        trickLabel = new Label() { Text = "Trick in Progress: ", Location = new Point(20, 460), Size = new Size(760, 30), Font = new Font("Arial", 12, FontStyle.Bold) };
        pluckInstructionLabel = new Label() { Text = "", Location = new Point(20, 500), Size = new Size(760, 30), Font = new Font("Arial", 12, FontStyle.Bold) };
        
        pluckSelectionBox = new ComboBox() { Location = new Point(20, 530), Size = new Size(200, 30), Enabled = false };

        statsLabel = new Label() { Text = "Statistics:\nPlayer 1: 0 Wins | Player 2: 0 Wins | Player 3: 0 Wins", Location = new Point(20, 580), Size = new Size(860, 50), Font = new Font("Arial", 12, FontStyle.Bold) };

        this.Controls.Add(dealerLabel);
        this.Controls.Add(trumpLabel);
        this.Controls.Add(playRoundButton);
        this.Controls.Add(playCardButton);
        this.Controls.Add(pluckCardButton);
        this.Controls.Add(player1Hand);
        this.Controls.Add(player2Hand);
        this.Controls.Add(player3Hand);
        this.Controls.Add(gameLog);
        this.Controls.Add(trickLabel);
        this.Controls.Add(pluckInstructionLabel);
        this.Controls.Add(pluckSelectionBox);
        this.Controls.Add(statsLabel);

        // Load sound effects
        cardPlaySound = new SoundPlayer("card_play.wav");
        pluckSound = new SoundPlayer("pluck.wav");

        game = new Game();
        UpdateUI();
    }

    private async void PlayRound_Click(object sender, EventArgs e)
    {
        game.PlayRound();
        await Task.Delay(500);
        DeterminePluckPhase();
        UpdateUI();
    }

    private void UpdateStatistics()
    {
        var stats = game.GetGameStatistics();
        statsLabel.Text = $"Statistics:\nPlayer 1: {stats["Player 1"]} Wins | Player 2: {stats["Player 2"]} Wins | Player 3: {stats["Player 3"]} Wins";
    }

    private async void PlayCard_Click(object sender, EventArgs e)
    {
        ListBox currentPlayerHand = GetCurrentPlayerHand();
        if (currentPlayerHand.SelectedItem != null)
        {
            string selectedCard = currentPlayerHand.SelectedItem.ToString();
            game.PlayCard(currentPlayer, selectedCard);
            cardPlaySound.Play();
            UpdateUI();
            
            await Task.Delay(500);
            UpdateStatistics();
            NextTurn();
        }
    }

    private void NextTurn()
    {
        PlayAITurns();
    }

    private void DeterminePluckPhase()
    {
        var pluckInfo = game.GetPluckDetails();
        if (pluckInfo != null)
        {
            plucker = pluckInfo.Item1;
            pluckee = pluckInfo.Item2;
            pluckInstructionLabel.Text = $"{plucker} must pluck from {pluckee}. Select a card to give.";
            pluckCardButton.Enabled = true;
            pluckSelectionBox.Enabled = true;
            
            pluckSelectionBox.Items.Clear();
            foreach (var card in game.GetPlayerHand(plucker))
            {
                pluckSelectionBox.Items.Add(card);
            }
        }
        else
        {
            pluckInstructionLabel.Text = "No plucking required this round.";
            pluckCardButton.Enabled = false;
            pluckSelectionBox.Enabled = false;
        }
    }

    private void PluckCard_Click(object sender, EventArgs e)
    {
        if (pluckSelectionBox.SelectedItem != null)
        {
            string selectedCard = pluckSelectionBox.SelectedItem.ToString();
            game.ExecutePluck(plucker, pluckee, selectedCard);
            pluckSound.Play();
            gameLog.Text += $"\n{plucker} plucked {selectedCard} from {pluckee}.";
            UpdateStatistics();
            UpdateUI();
        }
    }
}
